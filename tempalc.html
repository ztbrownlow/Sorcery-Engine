<canvas id="canvas" width="600" height="450">
  Canvas not supported
</canvas>
<script type="text/javascript">
  canvas = document.getElementById("canvas");
  context = canvas.getContext('2d');

  var elements = new Array();
  var onScreen = new Array();
  var unlocked = new Array();

  //The different elements we'll be mixing with alchemy
  function Element(name, src, width, height, unlocked = false) {
    this.name = name;
    this.unlocked = unlocked;
    this.interactions = {};
    this.image = new Image();
    this.image.src = src;
    this.image.width = width;
    this.image.height = height;
    var element = this;
    this.link = function(element2, element3) {
      element.interactions[element2.name] = element3;
      element2.interactions[element.name] = element3;
    }
    this.combine = function(element2) {
      return element.interactions[element2.name];
    }
  }

  function elementByName(name) {
    temp = elements.filter(function(e) { return e.name == name; });
    if (temp.length == 0) { //doesn't exist
      return null;
    } else {
      return temp[0];
    }
  }

  //link elements so element1+element2=element3
  function linkByName(element1, element2, element3) {
    elementByName(element1).link(elementByName(element2), elementByName(element3));
  }

  //everything above this comment has been tested at least a little bit

  function checkSprite(sprite, x, y) {
    var minX = sprite.x;
    var maxX = sprite.x + sprite.element.image.width;
    var minY = sprite.y;
    var maxY = sprite.y + sprite.element.image.height;
    var mx = x;
    var my = y;
    console.log(minX + " " + maxX);
    if (mx >= minX && mx <= maxX && my >= minY && my <= maxY) {
      return true;
    }
    return false;
  }

  var mouseX, mouseY;
  var selected;
  canvas.addEventListener("mousedown", function(e) {
    selected = onScreen.filter(function(e) { return checkSprite(e, mouseX, mouseY); });
    if (selected.length != 0) {
      selected = selected[0];
      for (var i = onScreen.indexOf(selected); i > 0; --i) {
        onScreen[i] = onScreen[i-1];
      }
      onScreen[0] = selected;
    } else {
      selected = undefined;
    }
  });
  canvas.addEventListener("mouseup", function(e) {
    if(selected != undefined) {
      selected.checkCollisions();
      selected = undefined;
    }
  });
  canvas.addEventListener("mousemove", function(e) {
    mouseX = e.offsetX;
    mouseY = e.offsetY;
    if (selected != undefined) {
      selected.x = mouseX - selected.element.image.width/2;
      selected.y = mouseY - selected.element.image.height/2;
    }
  });
  canvas.addEventListener("mouseout", function(e) {
    if(selected != undefined) {
      selected.checkCollisions();
      selected = undefined;
    }
  });

  //TEMP
  document.addEventListener("keydown", function(e){ onScreen.push(new Draggable("water")); onScreen.push(new Draggable("fire")); });

  //TODO depth stuff (using front/back of list)

  function Draggable(name) {
    this.element = elementByName(name);
    this.x = mouseX;
    this.y = mouseY;
    var o_this = this;
    this.collide = function(other) {
      var combined = o_this.element.combine(other.element);
      if (combined != undefined) {
        console.log(o_this.element.name + "+" + other.element.name + "=" + combined.name);
        this.element = combined;
        if (!combined.unlocked) {
          combined.unlocked = true;
          unlocked.push(combined)
        }
        onScreen.splice(onScreen.indexOf(other), 1); //remove other from screen
        return true;
      }
      return false;
    };
    this.checkCollide = function(other) {
      return (other != o_this && Math.hypot(other.x - o_this.x, other.y - o_this.y) < other.element.image.width); //assumes circles, width=height, same size
    }
    this.draw = function() {
      context.drawImage(o_this.element.image, o_this.x, o_this.y, o_this.element.image.width, o_this.element.image.height);
    };
    this.checkCollisions = function() {
      for(var i = 0; i < onScreen.length; ++i) {
        var item = onScreen[i];
        if (o_this.checkCollide(item)) {
          if (o_this.collide(item)) {
            return; //only collide with one and then stop
          }
        }
      }
    }
  }

  var imageSize = 64;

  function setup() {
    elements.push(new Element("fire", "http://www4.ncsu.edu/~rnpettit/csc481/la/fire.png", imageSize, imageSize, true));
    elements.push(new Element("water", "http://www4.ncsu.edu/~rnpettit/csc481/la/water.png", imageSize, imageSize, true));
    elements.push(new Element("steam", "http://www4.ncsu.edu/~rnpettit/csc481/la/steam.png", imageSize, imageSize, false));
    linkByName("fire", "water", "steam");
    unlocked = elements.filter(function(e) { return e.unlocked; });
  }

  function update() {
    //TODO Dunno if we actually need any updates
  }

  function draw() {
    canvas.width = canvas.width;
    drawDebugText();
    //TODO GUI
		drawGUI();
    for(var i = onScreen.length - 1; i >= 0; --i) {
      onScreen[i].draw();
    }
  }
	function drawGUI(){
		var numRows = 3;
		var w = canvas.width;
		var sepWidth = 3;
		var h = numRows * imageSize + ((2 + numRows) * sepWidth);

		//draw the bars
		context.fillStyle="#AAAAAA";
		context.fillRect(0, canvas.height - h, w, h);
		context.fillStyle="#BBBBBB";
		for( var i = 1; i <= numRows - 1; i++){
			var startHeight = canvas.height - h + (i * imageSize) + (i * sepWidth);
			context.fillRect(0,  startHeight, canvas.width, 3 + sepWidth);
		}
		//draw the elements	
	}
	
    //DEBUG TEXT//
    //provides a frame counter so we know that draw() is updating
  var frameNum = 0;
  function drawDebugText(){
    context.fillStyle = "black";
    context.font = "bold 12px Arial";
    context.fillText("Frame: " + frameNum, 0, 10);
    frameNum++;
  }

  function game_loop() {
    update();
    draw();
  }

  setup();
  setInterval(game_loop, 30);
  console.log(elementByName("water"));
  console.log(elementByName("fire"));
  console.log(elementByName("steam"));
</script>
